{
    "contents" : "covariate_inputs<-list(fall_discharge = list(covariate = \"discharge\",\n                                             month     = 10:12,\n                                             FUN       = median),\n                       winter_floods =  list(covariate = \"discharge\",\n                                             threshold = 0.98,\n                                             high.low  = \"high\",\n                                             freq.dur  = \"duration\",\n                                             month = c(12,1)),\n                       spring_floods =  list(covariate = \"discharge\",\n                                             threshold = 0.995,\n                                             high.low  = \"high\",\n                                             freq.dur  = \"duration\",\n                                             month = 2:3),\n                       summer_low =     list(covariate = \"discharge\",\n                                             month     = 6:9,\n                                             FUN       = min),\n#                                              threshold = 0.05,\n#                                              high.low  = \"low\",\n#                                              freq.dur  = \"duration\",\n#                                              month     = 6:9),\n                       summer_temp =    list(covariate = \"temperature\",\n                                             threshold = 20,\n                                             high.low  = \"high\",\n                                             freq.dur  = \"duration\",\n                                             month     = 6:9),\n                       winter_flow_mean =  list(covariate = \"discharge\",\n                                                month     = c(12,1),\n                                                FUN       = mean),\n                       spring_flow_mean =  list(covariate = \"discharge\",\n                                                month     = 2:3,\n                                                FUN       = mean),\n                       summer_flow_mean =  list(covariate = \"discharge\",\n                                                month     = c(6:8),\n                                                FUN       = mean),\n                       summer_temp_mean =  list(covariate = \"temperature\",\n                                                month     = c(6:8),\n                                                FUN       = mean)\n)\n\nenv.cov<-function(covariate,month,threshold=NA,high.low=NA,freq.dur=NA,FUN=NULL){\n  \n  if(!is.null(FUN) & any(!is.na(threshold),!is.na(high.low),!is.na(freq.dur))){\n    stop(\"cannot define both 'FUN' and threshold/high.low/freq.dur\")\n  }  \n\n  if(!covariate %in% c('discharge','temperature')){\n    stop(\"covariate must equal 'discharge' or 'temperature'\")}\n  \n  ed<-ed[date >= as.Date(paste0(start_year-1,\"-10-01\")) & \n         date < as.Date(paste0(end_year,\"-10-01\"))]\n  ed[,year_of_effect:=year(date)]\n  ed[month(date)>=10,year_of_effect:=year(date)+1]\n  \n  rivers<-unique(ed$river)\n  \n  result<-array(NA,dim=c(length(unique(year(ed$date)))-1,4))\n  \n  if(is.null(FUN)){\n\n\n  if(!high.low %in% c('high','low')){\n    stop(\"covariate must equal 'high' or 'low' defining whether the event is a high or low extreme\")}\n  \n  if(!freq.dur %in% c('frequency','duration')){\n    stop(\"covariate must equal 'frequency' or 'duration' defining whether the function returns the number of days when the threshold is crossed (duration) or the number of times(frequency)\")}\n\n  if(covariate == 'discharge' & (is.na(threshold) | threshold<0 | threshold > 1)){\n    stop(\"for discharge covariates threshold must be a number between 0 and 1 representing the quantile definition of an extreme event\")\n  }\n  \n  num.sets<-function(x){\n    if(length(x)==0){return(as.integer(0))} else\n      xlag<-c(-1,x[1:(length(x)-1)])\n    return(length(which(x-xlag>1)))\n  }\n\n\n  limit<-NULL\n  for(r in 1:4){\n    if(covariate==\"discharge\") {limit[r]<-quantile(ed[river==rivers[r],get(covariate)],probs=threshold,na.rm=T)}\n    if(covariate==\"temperature\") {limit[r]<-threshold}\n  }\n  \n  for(r in 1:4){\n    if(freq.dur==\"frequency\"){result[,r]<-ed[river==rivers[r]&month(date) %in% month,\n                                             ifelse(high.low==\"high\",\n                                             num.sets(which(get(covariate) >= limit[r])),\n                                             num.sets(which(get(covariate) <= limit[r]))),\n                                             by=year_of_effect]$V1\n    }\n    \n    if(freq.dur==\"duration\"){result[,r]<-ed[river==rivers[r]&month(date) %in% month,\n                                             ifelse(high.low==\"high\",\n                                                    length(which(get(covariate) >= limit[r])),\n                                                    length(which(get(covariate) <= limit[r]))),\n                                             by=year_of_effect]$V1\n    }\n  }} else{ #if FUN isn't null\n    \n    for(r in 1:4){\n      result[,r]<-ed[river == rivers[r] & month(date) %in% month,\n                     FUN(get(covariate)),\n                     by = year_of_effect]$V1\n    }\n  }\n  \n  scale_simple<-function(x) {\n    a<-scale(x)\n    return(a[,1])}\n  result<-apply(result,2,scale_simple)\n  \n  return(result)\n}\n\n\ncovariates<-array(dim=c(end_year-start_year+1,4,length(names(covariate_inputs))))\ndimnames(covariates)<-list(start_year:end_year,\n                           unique(ed$rivers),\n                           names(covariate_inputs))\n\nfor(i in 1:length(names(covariate_inputs))){\n  covariates[,,i]<-do.call(env.cov,covariate_inputs[[i]])\n}\n\nassign('covariates',covariates,env=shared_data)\nsaveRDS(covariates,\"~/process-data/data_store/processed_data/covariates.rds\")\n\n\n",
    "created" : 1430764285899.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3699726855",
    "id" : "CF001E64",
    "lastKnownWriteTime" : 1430240281,
    "path" : "C:/Users/Evan/Desktop/Conte/trout_yoy/env_prep/create_covariates.R",
    "project_path" : null,
    "properties" : {
    },
    "source_on_save" : false,
    "type" : "r_source"
}